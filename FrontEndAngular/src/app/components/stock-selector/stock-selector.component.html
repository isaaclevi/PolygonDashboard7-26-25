<div class="stock-selector-container">
  <div class="stock-selector-label">
    <label for="stock-selector">Select Stock Symbol</label>
    <button 
      class="refresh-btn" 
      (click)="refreshTickerData()" 
      [disabled]="isLoading"
      type="button"
      title="Refresh ticker data from Polygon.io">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
      </svg>
    </button>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="24"></mat-spinner>
    <span>{{ getLoadingProgress() }}</span>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="loadingError">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
      <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
    </svg>
    <span>{{ loadingError }}</span>
  </div>
  
  <div class="stock-selector-dropdown" 
       id="stock-selector"
       role="combobox"
       [attr.aria-expanded]="isDropdownOpen"
       aria-haspopup="listbox"
       aria-label="Select stock symbol"
       (clickOutside)="closeDropdown()" 
       *ngIf="!isLoading">
    <!-- Selected Stock Display -->
    <div class="selected-stock" 
         role="button"
         tabindex="0"
         (click)="toggleDropdown()"
         (keydown)="onKeyDown($event)">
      <div class="stock-info" *ngIf="getSelectedStockInfo(); let selectedInfo">
        <span class="symbol">{{ selectedInfo.symbol }}</span>
        <span class="name">{{ selectedInfo.name }}</span>
        <div class="additional-info">
          <span class="sector">{{ selectedInfo.sector }}</span>
          <span class="market-cap" *ngIf="selectedInfo.marketCap">{{ getMarketCapDisplay(selectedInfo.marketCap) }}</span>
          <span class="exchange" *ngIf="selectedInfo.exchange">[{{ selectedInfo.exchange }}]</span>
        </div>
      </div>
      <div class="stock-info" *ngIf="!getSelectedStockInfo()">
        <span class="placeholder">Select a stock...</span>
      </div>
      <div class="dropdown-arrow" [class.open]="isDropdownOpen">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M3.646 4.646a.5.5 0 0 1 .708 0L8 8.292l3.646-3.646a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 0-.708z"/>
        </svg>
      </div>
    </div>

    <!-- Dropdown Content -->
    <div class="dropdown-content" *ngIf="isDropdownOpen">
      <!-- Filter Input -->
      <div class="filter-container">
        <input 
          type="text" 
          class="filter-input"
          id="stock-filter"
          placeholder="Filter by symbol, name, sector, or description..."
          [(ngModel)]="filterText"
          (input)="onFilterChange()"
          #filterInput
          aria-label="Filter stock options"
          role="searchbox">
        <button 
          class="clear-filter-btn" 
          *ngIf="filterText" 
          (click)="clearFilter()"
          type="button">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
          </svg>
        </button>
      </div>

      <!-- Ticker Count Display -->
      <div class="ticker-count" *ngIf="stockOptions.length > 0">
        <span>Showing {{ filteredStockOptions.length }} of {{ stockOptions.length.toLocaleString() }} tickers</span>
        <div class="sync-indicators">
          <span class="data-source-indicator" 
                [class.offline]="isUsingLocalData"
                [class.limited]="!hasComprehensiveData() && !isUsingLocalData"
                [title]="getSyncStatusDisplay()">
            {{ getDataSourceDisplay() }}
          </span>
          <span class="sync-status" *ngIf="syncStatus === 'complete' && (lastSyncInfo.added > 0 || lastSyncInfo.removed > 0)" 
                title="Recent synchronization changes">
            +{{ lastSyncInfo.added }} -{{ lastSyncInfo.removed }}
          </span>
        </div>
      </div>

      <!-- Stock Options List -->
      <div class="options-container" 
           role="listbox"
           aria-label="Available stock options">
        <div class="option-item" 
             *ngFor="let stock of filteredStockOptions; trackBy: trackBySymbol; let i = index" 
             (click)="onStockSelect(stock)"
             [class.selected]="stock.symbol === selectedStock"
             role="option"
             [attr.aria-selected]="stock.symbol === selectedStock"
             [attr.aria-posinset]="i + 1"
             [attr.aria-setsize]="filteredStockOptions.length"
             [attr.data-symbol]="stock.symbol"
             tabindex="-1">
          <div class="option-content">
            <div class="primary-info">
              <div class="symbol">{{ stock.symbol }}</div>
              <div class="name">{{ stock.name }}</div>
            </div>
            <div class="secondary-info">
              <div class="sector">{{ stock.sector }}</div>
              <div class="market-info">
                <span class="market-cap" *ngIf="stock.marketCap">{{ getMarketCapDisplay(stock.marketCap) }}</span>
                <span class="exchange" *ngIf="stock.exchange">[{{ stock.exchange }}]</span>
              </div>
            </div>
            <div class="description" *ngIf="stock.description">
              {{ stock.description.length > 100 ? (stock.description | slice:0:100) + '...' : stock.description }}
            </div>
          </div>
          <div class="check-icon" *ngIf="stock.symbol === selectedStock">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
            </svg>
          </div>
        </div>
        
        <!-- No Results Message -->
        <div class="no-results" *ngIf="filteredStockOptions.length === 0 && stockOptions.length > 0">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
          </svg>
          <p>No stocks found matching "{{ filterText }}"</p>
          <button class="clear-filter-btn" (click)="clearFilter()">Clear Filter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Stock Summary -->
  <div class="selected-summary" *ngIf="getSelectedStockInfo() && !isLoading">
    <div class="summary-content" *ngIf="getSelectedStockInfo() as selectedInfo">
      <h4>{{ selectedInfo.symbol }} - {{ selectedInfo.name }}</h4>
      <div class="summary-details">
        <p class="sector-tag">{{ selectedInfo.sector }}</p>
        <p class="market-cap" *ngIf="selectedInfo.marketCap">{{ getMarketCapDisplay(selectedInfo.marketCap) }}</p>
        <p class="exchange" *ngIf="selectedInfo.exchange">Listed on {{ selectedInfo.exchange }}</p>
      </div>
      <p class="description" *ngIf="selectedInfo.description">{{ selectedInfo.description }}</p>
    </div>
  </div>
</div>
